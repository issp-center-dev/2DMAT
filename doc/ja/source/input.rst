入力ファイル
================================

py2dmat は入力ファイルの形式に `TOML <https://toml.io/ja/>`_ を採用しています。
入力ファイルは次の4つのセクションから構成されます。

- ``base``

  - ``py2dmat`` 全体のパラメータを指定します。

- ``solver``

  - ``Solver`` のパラメータを指定します。

- ``algorithm``

  - ``Algorithm`` のパラメータを指定します。

- ``runner``

  - ``Runner`` のパラメータを指定します。

[``base``] セクション
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

- ``dimension``

  形式: 整数型

  説明: 探索空間の次元(探索するパラメータの数)

- ``root_dir``

  形式: string型 (default: プログラム実行時のディレクトリ)

  説明: プログラムを実行する一番上のディレクトリ。
        入力ファイルなどのパスはすべて ``root_dir`` を起点とします。

- ``output_dir``

  形式: string型 (default: プログラム実行時のディレクトリ)

  説明: プログラムの実行結果を出力するディレクトリ名

[``solver``] セクション
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

``name`` でソルバーの種類を決定します。各パラメータはソルバーごとに定義されています。

- ``name``

  形式: string型

  説明: ソルバーの名前。以下のソルバーが用意されています。

    - ``analytical`` : 解析関数を与えるソルバー (主にテストに利用)

    以下は別モジュールとして配布される2次元物質構造解析向けソルバーです。

    - ``sim-trhepd-rheed`` : 反射高速(陽)電子回折(RHEED, TRHEPD)の強度計算をするためのソルバー

    - ``sxrd`` : 表面X線回折(SXRD)解析のためのソルバー

    - ``leed`` : 低速電子線回折(LEED)解析のためのソルバー

- ``dimension``
  
  形式: 整数型 (default: ``base.dimension``)

  説明: ソルバーが受け取る入力パラメータの数。


各種ソルバーの詳細および入出力ファイルは :doc:`solver/index` を参照してください。

.. _input_algorithm:

[``algorithm``] セクション
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

``name`` でアルゴリズムの種類を決定します。各パラメータはアルゴリズムごとに定義されています。

- ``name``

  形式: string型

  説明: アルゴリズムの名前。以下のアルゴリズムが用意されています。

    - ``minsearch``: Nelder-Mead法による最小値探索

    - ``mapper``: グリッド探索

    - ``exchange``:  レプリカ交換モンテカルロ法

    - ``pamc``:  ポピュレーションアニーリングモンテカルロ法

    - ``bayes``:  ベイズ最適化

- ``seed``

  形式: 整数値

  説明: 初期値のランダム生成やモンテカルロ更新などで用いる擬似乱数生成器の種を指定します。
        各MPIプロセスに対して、 ``seed + mpi_rank * seed_delta`` の値が実際の種として用いられます。
        省略した場合は `Numpy の規定の方法 <https://numpy.org/doc/stable/reference/random/legacy.html#numpy.random.RandomState>`_ で初期化されます。


- ``seed_delta``

  形式: 整数値 (default: 314159)

  説明: 疑似乱数生成器の種について、MPI プロセスごとの値を計算する際に用いられます。
        詳しくは ``seed`` を参照してください。

- ``checkpoint``

  形式: bool値 (default: false)

  説明: 実行中および終了時の状態を定期的にファイルに出力します。実行が中断した場合に、チェックポイントから実行を再開できます。

- ``checkpoint_steps``

  形式: 整数値 (default: 16,777,216)

  説明: 次のチェックポイントまでの繰り返し回数を指定します。繰り返し回数は、mapper の場合はグリッド点の数、bayes の場合は探索点の評価回数、モンテカルロ法(exchange, pamc) の場合は local update の回数です。
  デフォルト値は十分大きな数が設定されています。チェックポイント機能を有効にするには、 ``checkpoint_steps`` または ``checkpoint_interval`` の少なくとも一方を設定する必要があります。

- ``checkpoint_interval``

  形式: 実数値 (default: 31,104,000)

  説明: 次のチェックポイントまでの経過時間を指定します。単位は秒です。
  デフォルト値は十分大きな数(360日)が設定されています。チェックポイント機能を有効にするには、 ``checkpoint_steps`` または ``checkpoint_interval`` の少なくとも一方を設定する必要があります。

- ``checkpoint_file``

  形式: 文字列 (default: ``"status.pickle"``)
	
  説明: 実行中の状態を書き出すファイル名を指定します。ファイルはプロセスごとの出力ディレクトリに書き出されます。過去3世代分のファイルが .1, .2, .3 の suffix を付けて保存されます。

  
各種アルゴリズムの詳細および入出力ファイルは :doc:`algorithm/index` を参照してください。


[``runner``] セクション
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

``Algorithm`` と ``Solver`` を橋渡しする要素である ``Runner`` の設定を記述します。
サブセクションとして ``mapping``, ``limitation``, ``log`` を持ちます。


[``runner.mapping``] セクション
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

``Algorithm`` で探索している :math:`N` 次元のパラメータ :math:`x` から ``Solver`` で使う :math:`M` 次元のパラメータ :math:`y` への写像を定義します。
:math:`N \ne M` となる場合には、 ``solver`` セクションにも ``dimension`` パラメータを指定してください。

現在はアフィン写像(線形写像+平行移動) :math:`y = Ax+b` が利用可能です。

- ``A``

  形式: リストのリスト、あるいは文字列 (default: [])

  説明: :math:`N \times M` の変換行列 :math:`A` 。空のリストを渡した場合、単位行列とみなされます。
        文字列として与える場合はそのまま行列の要素を空白および改行で区切って並べてください。

- ``b``

  形式: リスト、あるいは文字列 (default: [])

  説明: :math:`M` 次元の並進移動ベクトル :math:`b` 。空のリストを渡した場合、ゼロベクトルとみなされます。
        文字列として与える場合はそのままベクトルの要素を空白区切りで並べてください。

行列の指定方法について、例えば、 ::

  A = [[1,1], [0,1]]

と ::

  A = """
  1 1
  0 1
  """

はともに

.. math::

  A = \left(
  \begin{matrix}
  1 & 1 \\
  0 & 1
  \end{matrix}
  \right)

を表します。

[``runner.limitation``] セクション
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

``Algorithm`` で探索している :math:`N` 次元のパラメータ :math:`x` に、制約条件を課すことが出来ます。
``Algorithm`` ごとに定義する探索範囲(例：``exchange`` の ``min_list`` や ``max_list`` ) に加えて課すことが出来ます。
現在は :math:`M` 行 :math:`N` 列の行列 :math:`A` と :math:`M` 次元の縦ベクトル :math:`b` から定義される :math:`Ax+b>0` の制約式が利用可能です。具体的に

.. math::

  A_{1,1} x_{1} + A_{1,2} x_{2} + &... + A_{1,N} x_{N} + b_{1} > 0\\
  A_{2,1} x_{1} + A_{2,2} x_{2} + &... + A_{2,N} x_{N} + b_{2} > 0\\
  &...\\
  A_{M,1} x_{1} + A_{M,2} x_{2} + &... + A_{M,N} x_{N} + b_{M} > 0 

という制約をかけることができます。
ここで :math:`M` は制約式の個数(任意)となります。 

- ``co_a``

  形式: リストのリスト、あるいは文字列 (default: [])

  説明: 制約式の行列 :math:`A` を設定します。

        行数は制約式数 :math:`M` 、列数は探索変数の数 :math:`N` である必要があります。

        ``co_b`` を同時に定義する必要があります。

- ``co_b``

  形式: リストのリスト、あるいは文字列 (default: [])

  説明: 制約式の縦ベクトル :math:`b` を設定します。

        次元数が制約式数 :math:`M` の縦ベクトルを設定する必要があります。

        ``co_a`` を同時に定義する必要があります。

行列の指定方法について、[``mapping``] セクションと同様で、例えば、 ::

  A = [[1,1], [0,1]]

と

.. code-block:: toml

  A = """
  1 1
  0 1
  """

はともに

.. math::

  A = \left(
  \begin{matrix}
  1 & 1 \\
  0 & 1
  \end{matrix}
  \right)

を表します。また、

.. code-block:: toml
  
  co_b = [[0], [-1]]

と

.. code-block:: toml

  co_b = """0 -1"""
  
と

.. code-block:: toml

  co_b = """
  0 
  -1
  """

はともに

.. math::

  b = \left(
  \begin{matrix}
  0 \\
  -1 
  \end{matrix}
  \right)

を表します。
``co_a`` と ``co_b`` のどちらも定義しない場合、制約式を課さずに探索します。

[``runner.log``] セクション
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

solver 呼び出しのlogging に関する設定です。

- ``filename``

  形式: 文字列 (default: "runner.log")

  説明: ログファイルの名前。

- ``interval``

  形式: 整数 (default: 0)

  説明: solver を interval 回呼ぶ毎にログが書き出されます。0以下の場合、ログ書き出しは行われません。

- ``write_result``

  形式: 真偽値 (default: false)

  説明: solver からの出力を記録するかどうかを指定します。

- ``write_input``

  形式: 真偽値 (default: false)

  説明: solver への入力を記録するかどうかを指定します。
