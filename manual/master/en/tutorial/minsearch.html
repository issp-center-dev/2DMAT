<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Optimization by Nelder-Mead method &#8212; 2DMAT 2.2.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/haiku.css?v=dfa0e015" />
    <script src="../_static/documentation_options.js?v=b21de401"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Grid search" href="mpi.html" />
    <link rel="prev" title="TRHEPD Direct Problem Solver" href="sim_trhepd_rheed.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../index.html">
          <span>2DMAT 2.2.0 documentation</span></a></h1>
        <h2 class="heading"><span>Optimization by Nelder-Mead method</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="sim_trhepd_rheed.html">TRHEPD Direct Problem Solver</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="mpi.html">Grid search</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="optimization-by-nelder-mead-method">
<h1>Optimization by Nelder-Mead method<a class="headerlink" href="#optimization-by-nelder-mead-method" title="Link to this heading">¶</a></h1>
<p>In this section, we will explain how to calculate the inverse problem of analyzing atomic coordinates from diffraction data using the Nelder-Mead method.
The specific calculation procedure is as follows.</p>
<ol class="arabic" start="0">
<li><p>Preparation of the reference file</p>
<p>Prepare the reference file to be matched (in this tutorial, it corresponds to <code class="docutils literal notranslate"><span class="pre">experiment.txt</span></code> described below).</p>
</li>
<li><p>Perform calculations on the bulk part of the surface structure.</p>
<p>Copy <code class="docutils literal notranslate"><span class="pre">bulk.exe</span></code> to <code class="docutils literal notranslate"><span class="pre">sample/sim-trhepd-rheed/minsearch</span></code> and run the calculation.</p>
</li>
<li><p>Run the main program</p>
<p>Run the calculation using <code class="docutils literal notranslate"><span class="pre">src/py2dmat_main.py</span></code> to estimate the atomic coordinates.</p>
</li>
</ol>
<p>In the main program, the Nelder-Mead method (using <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.fmin.html">scipy.optimize.fmin</a>) is used. ) to find the parameter that minimizes the deviation (R-value) between the intensity obtained using the solver (in this case <code class="docutils literal notranslate"><span class="pre">surf.exe</span></code>) and the intensity listed in the reference file (<code class="docutils literal notranslate"><span class="pre">experiment.txt</span></code>).</p>
<section id="location-of-the-sample-files">
<h2>Location of the sample files<a class="headerlink" href="#location-of-the-sample-files" title="Link to this heading">¶</a></h2>
<p>The sample files are located in <code class="docutils literal notranslate"><span class="pre">sample/py2dmat/sim-trhepd-rheed/single_beam/minsearch</span></code>.
The following files are stored in the folder.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">bulk.txt</span></code></p>
<p>Input file of <code class="docutils literal notranslate"><span class="pre">bulk.exe</span></code>.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">experiment.txt</span></code> , <code class="docutils literal notranslate"><span class="pre">template.txt</span></code></p>
<p>Reference file to proceed with calculations in the main program.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">ref.txt</span></code></p>
<p>A file containing the answers you want to seek in this tutorial.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">input.toml</span></code></p>
<p>Input file of the main program.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">prepare.sh</span></code> , <code class="docutils literal notranslate"><span class="pre">do.sh</span></code></p>
<blockquote>
<div><p>Script prepared for doing all calculation of this tutorial</p>
</div></blockquote>
</li>
</ul>
<p>The following sections describe these files and then show the actual calculation results.</p>
</section>
<section id="the-reference-file">
<h2>The reference file<a class="headerlink" href="#the-reference-file" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">template.txt</span></code> file is almost the same format as the input file for <code class="docutils literal notranslate"><span class="pre">surf.exe</span></code>.
The parameters to be run (such as the atomic coordinates you want to find) are rewritten as <code class="docutils literal notranslate"><span class="pre">value_*</span></code> or some other appropriate string.
The following is the content of <code class="docutils literal notranslate"><span class="pre">template.txt</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span>                                    <span class="p">,</span><span class="n">NELMS</span><span class="p">,</span>  <span class="o">--------</span> <span class="n">Ge</span><span class="p">(</span><span class="mi">001</span><span class="p">)</span><span class="o">-</span><span class="n">c4x2</span>
<span class="mi">32</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.1</span>                           <span class="p">,</span><span class="n">Ge</span> <span class="n">Z</span><span class="p">,</span><span class="n">da1</span><span class="p">,</span><span class="n">sap</span>
<span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span><span class="p">,</span><span class="mf">0.6</span>                          <span class="p">,</span><span class="n">BH</span><span class="p">(</span><span class="n">I</span><span class="p">),</span><span class="n">BK</span><span class="p">(</span><span class="n">I</span><span class="p">),</span><span class="n">BZ</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
<span class="mi">32</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.1</span>                           <span class="p">,</span><span class="n">Ge</span> <span class="n">Z</span><span class="p">,</span><span class="n">da1</span><span class="p">,</span><span class="n">sap</span>
<span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span>                          <span class="p">,</span><span class="n">BH</span><span class="p">(</span><span class="n">I</span><span class="p">),</span><span class="n">BK</span><span class="p">(</span><span class="n">I</span><span class="p">),</span><span class="n">BZ</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
<span class="mi">9</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span>               <span class="p">,</span><span class="n">NSGS</span><span class="p">,</span><span class="n">msa</span><span class="p">,</span><span class="n">msb</span><span class="p">,</span><span class="n">nsa</span><span class="p">,</span><span class="n">nsb</span><span class="p">,</span><span class="n">dthick</span><span class="p">,</span><span class="n">DXS</span><span class="p">,</span><span class="n">DYS</span>
<span class="mi">8</span>                                    <span class="p">,</span><span class="n">NATM</span>
<span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.34502591</span>  <span class="mi">1</span>       <span class="n">value_01</span>   <span class="p">,</span><span class="n">IELM</span><span class="p">(</span><span class="n">I</span><span class="p">),</span><span class="n">ocr</span><span class="p">(</span><span class="n">I</span><span class="p">),</span><span class="n">X</span><span class="p">(</span><span class="n">I</span><span class="p">),</span><span class="n">Y</span><span class="p">(</span><span class="n">I</span><span class="p">),</span><span class="n">Z</span><span class="p">(</span><span class="n">I</span><span class="p">)</span>
<span class="mi">1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.752457792</span> <span class="mi">1</span>       <span class="n">value_02</span>
<span class="mi">2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.480003343</span> <span class="mf">1.465005851</span>     <span class="n">value_03</span>
<span class="mi">2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">2</span>   <span class="mf">1.497500418</span>     <span class="mf">2.281675</span>
<span class="mi">2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">1</span>   <span class="mf">1.5</span>     <span class="mf">1.991675</span>
<span class="mi">2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span>   <span class="mi">1</span>       <span class="mf">0.847225</span>
<span class="mi">2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">2</span>   <span class="mi">1</span>       <span class="mf">0.807225</span>
<span class="mi">2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.009998328</span> <span class="mi">1</span>       <span class="mf">0.597225</span>
<span class="mi">1</span><span class="p">,</span><span class="mi">1</span>                                  <span class="p">,(</span><span class="n">WDOM</span><span class="p">,</span><span class="n">I</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NDOM</span><span class="p">)</span>
</pre></div>
</div>
<p>In this input file, <code class="docutils literal notranslate"><span class="pre">value_01</span></code>, <code class="docutils literal notranslate"><span class="pre">value_02</span></code>, and <code class="docutils literal notranslate"><span class="pre">value_03</span></code> are used.
In the sample folder, there is a reference file <code class="docutils literal notranslate"><span class="pre">ref.txt</span></code> to know if the atomic positions are estimated correctly. The contents of this file are</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fx</span> <span class="o">=</span> <span class="mf">7.382680568652868e-06</span>
<span class="n">z1</span> <span class="o">=</span> <span class="mf">5.230524973874179</span>
<span class="n">z2</span> <span class="o">=</span> <span class="mf">4.370622919269477</span>
<span class="n">z3</span> <span class="o">=</span> <span class="mf">3.5961444501081647</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">value_0x</span></code> corresponds to <code class="docutils literal notranslate"><span class="pre">z_x</span></code> (x=1, 2, 3).
<code class="docutils literal notranslate"><span class="pre">fx</span></code> is the optimal value of the objective function.
The <code class="docutils literal notranslate"><span class="pre">experiment.txt</span></code> is a file that is used as a reference in the main program, and is equivalent to <code class="docutils literal notranslate"><span class="pre">convolution.txt</span></code>, which is calculated by putting the parameters in <code class="docutils literal notranslate"><span class="pre">ref.txt</span></code> into <code class="docutils literal notranslate"><span class="pre">template.txt</span></code> and following the same procedure as in the tutorial on direct problems. (Note that the input files for <code class="docutils literal notranslate"><span class="pre">bulk.exe</span></code> and <code class="docutils literal notranslate"><span class="pre">suft.exe</span></code> are different from those in the sequential problem tutorial.)</p>
</section>
<section id="input-file">
<h2>Input file<a class="headerlink" href="#input-file" title="Link to this heading">¶</a></h2>
<p>In this section, we will prepare the input file <code class="docutils literal notranslate"><span class="pre">input.toml</span></code> for the main program.
The details of <code class="docutils literal notranslate"><span class="pre">input.toml</span></code> can be found in the input file.
This section describes the contents of <code class="docutils literal notranslate"><span class="pre">input.toml</span></code> in the sample file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">base</span><span class="p">]</span>
<span class="n">dimension</span> <span class="o">=</span> <span class="mi">3</span>

<span class="p">[</span><span class="n">solver</span><span class="p">]</span>
<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;sim-trhepd-rheed&quot;</span>

<span class="p">[</span><span class="n">solver</span><span class="o">.</span><span class="n">config</span><span class="p">]</span>
<span class="n">calculated_first_line</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">calculated_last_line</span> <span class="o">=</span> <span class="mi">74</span>
<span class="n">row_number</span> <span class="o">=</span> <span class="mi">2</span>

<span class="p">[</span><span class="n">solver</span><span class="o">.</span><span class="n">param</span><span class="p">]</span>
<span class="n">string_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;value_01&quot;</span><span class="p">,</span> <span class="s2">&quot;value_02&quot;</span><span class="p">,</span> <span class="s2">&quot;value_03&quot;</span> <span class="p">]</span>
<span class="n">degree_max</span> <span class="o">=</span> <span class="mf">7.0</span>

<span class="p">[</span><span class="n">solver</span><span class="o">.</span><span class="n">reference</span><span class="p">]</span>
<span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;experiment.txt&quot;</span>
<span class="n">first</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">last</span> <span class="o">=</span> <span class="mi">70</span>

<span class="p">[</span><span class="n">algorithm</span><span class="p">]</span>
<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;minsearch&quot;</span>
<span class="n">label_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;z1&quot;</span><span class="p">,</span> <span class="s2">&quot;z2&quot;</span><span class="p">,</span> <span class="s2">&quot;z3&quot;</span><span class="p">]</span>

<span class="p">[</span><span class="n">algorithm</span><span class="o">.</span><span class="n">param</span><span class="p">]</span>
<span class="n">min_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]</span>
<span class="n">max_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">]</span>
<span class="n">initial_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">5.25</span><span class="p">,</span> <span class="mf">4.25</span><span class="p">,</span> <span class="mf">3.50</span><span class="p">]</span>
</pre></div>
</div>
<p>First, <code class="docutils literal notranslate"><span class="pre">[base]</span></code> section is explained.</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">dimension</span></code> is the number of variables to be optimized, in this case <code class="docutils literal notranslate"><span class="pre">3</span></code> since we are optimizing three variables as described in <code class="docutils literal notranslate"><span class="pre">template.txt</span></code>.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">[solver]</span></code> section specifies the solver to be used inside the main program and its settings.</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">name</span></code> is the name of the solver you want to use, which in this tutorial is <code class="docutils literal notranslate"><span class="pre">sim-trhepd-rheed</span></code>, since we will be using it for our analysis.</p></li>
</ul>
<p>The solver can be configured in the subsections <code class="docutils literal notranslate"><span class="pre">[solver.config]</span></code>, <code class="docutils literal notranslate"><span class="pre">[solver.param]</span></code>, and <code class="docutils literal notranslate"><span class="pre">[solver.reference]</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">[solver.config]</span></code> section specifies options for reading the output file produced by the main program’s internal call, <code class="docutils literal notranslate"><span class="pre">surf.exe</span></code>.</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">calculated_first_line</span></code> specifies the first line to read from the output file.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">calculated_last_line</span></code> specifies the last line of the output file to be read.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">row_number</span></code> specifies the number of columns in the output file to read.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">[solver.param]</span></code> section specifies options for reading the output file produced by the main program’s internal call, <code class="docutils literal notranslate"><span class="pre">surf.exe</span></code>.</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">string_list</span></code> is a list of variable names to be read in <code class="docutils literal notranslate"><span class="pre">template.txt</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">degree_max</span></code> specifies the maximum angle in degrees.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">[solver.reference]</span></code> section specifies the location of the experimental data and the range to read.</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">path</span></code> specifies the path where the experimental data is located.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">first</span></code> specifies the first line of the experimental data file to read.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">end</span></code> specifies the last line of the experimental data file to read.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">[algorithm]</span></code> section specifies the algorithm to use and its settings.</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">name</span></code> is the name of the algorithm you want to use, in this tutorial we will use <code class="docutils literal notranslate"><span class="pre">minsearch</span></code> since we will be using the Nelder-Mead method.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">label_list</span></code> is a list of label names to be added to the output of <code class="docutils literal notranslate"><span class="pre">value_0x</span></code> (x=1,2,3).</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">[algorithm.param]</span></code> section specifies the range of parameters to search and their initial values.</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">min_list</span></code> and <code class="docutils literal notranslate"><span class="pre">max_list</span></code> specify the minimum and maximum values of the search range, respectively.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">initial_list</span></code> specifies the initial values.</p></li>
</ul>
<p>Other parameters, such as convergence judgments used in the Nelder-Mead method, can be done in the <code class="docutils literal notranslate"><span class="pre">[algorithm]</span></code> section, although they are omitted here because the default values are used.
See the input file chapter for details.</p>
</section>
<section id="calculation-execution">
<h2>Calculation execution<a class="headerlink" href="#calculation-execution" title="Link to this heading">¶</a></h2>
<p>First, move to the folder where the sample files are located (we will assume that you are directly under the directory where you downloaded this software).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">sample</span><span class="o">/</span><span class="n">sim</span><span class="o">-</span><span class="n">trhepd</span><span class="o">-</span><span class="n">rheed</span><span class="o">/</span><span class="n">single_beam</span><span class="o">/</span><span class="n">minsearch</span>
</pre></div>
</div>
<p>Copy <code class="docutils literal notranslate"><span class="pre">bulk.exe</span></code> and <code class="docutils literal notranslate"><span class="pre">surf.exe</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">../../../../../</span><span class="n">sim</span><span class="o">-</span><span class="n">trhepd</span><span class="o">-</span><span class="n">rheed</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">TRHEPD</span><span class="o">/</span><span class="n">bulk</span><span class="o">.</span><span class="n">exe</span> <span class="o">.</span>
<span class="n">cp</span> <span class="o">../../../../../</span><span class="n">sim</span><span class="o">-</span><span class="n">trhepd</span><span class="o">-</span><span class="n">rheed</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">TRHEPD</span><span class="o">/</span><span class="n">surf</span><span class="o">.</span><span class="n">exe</span> <span class="o">.</span>
</pre></div>
</div>
<p>First, run <code class="docutils literal notranslate"><span class="pre">bulk.exe</span></code> to create <code class="docutils literal notranslate"><span class="pre">bulkP.b</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">bulk</span><span class="o">.</span><span class="n">exe</span>
</pre></div>
</div>
<p>After that, run the main program (the computation time takes only a few seconds on a normal PC).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="o">../../../../</span><span class="n">src</span><span class="o">/</span><span class="n">py2dmat_main</span><span class="o">.</span><span class="n">py</span> <span class="nb">input</span><span class="o">.</span><span class="n">toml</span> <span class="o">|</span> <span class="n">tee</span> <span class="n">log</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>Then, the standard output will be seen as follows.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Read</span> <span class="n">experiment</span><span class="o">.</span><span class="n">txt</span>
<span class="n">z1</span> <span class="o">=</span>  <span class="mf">5.25000</span>
<span class="n">z2</span> <span class="o">=</span>  <span class="mf">4.25000</span>
<span class="n">z3</span> <span class="o">=</span>  <span class="mf">3.50000</span>
<span class="p">[</span><span class="s1">&#39; 5.25000&#39;</span><span class="p">,</span> <span class="s1">&#39; 4.25000&#39;</span><span class="p">,</span> <span class="s1">&#39; 3.50000&#39;</span><span class="p">]</span>
<span class="n">PASS</span> <span class="p">:</span> <span class="n">degree</span> <span class="ow">in</span> <span class="n">lastline</span> <span class="o">=</span> <span class="mf">7.0</span>
<span class="n">PASS</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">calculated_list</span><span class="p">)</span> <span class="mi">70</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">convolution_I_calculated_list</span><span class="p">)</span><span class="mi">70</span>
<span class="n">R</span><span class="o">-</span><span class="n">factor</span> <span class="o">=</span> <span class="mf">0.015199251773721183</span>
<span class="n">z1</span> <span class="o">=</span>  <span class="mf">5.50000</span>
<span class="n">z2</span> <span class="o">=</span>  <span class="mf">4.25000</span>
<span class="n">z3</span> <span class="o">=</span>  <span class="mf">3.50000</span>
<span class="p">[</span><span class="s1">&#39; 5.50000&#39;</span><span class="p">,</span> <span class="s1">&#39; 4.25000&#39;</span><span class="p">,</span> <span class="s1">&#39; 3.50000&#39;</span><span class="p">]</span>
<span class="n">PASS</span> <span class="p">:</span> <span class="n">degree</span> <span class="ow">in</span> <span class="n">lastline</span> <span class="o">=</span> <span class="mf">7.0</span>
<span class="n">PASS</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">calculated_list</span><span class="p">)</span> <span class="mi">70</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">convolution_I_calculated_list</span><span class="p">)</span><span class="mi">70</span>
<span class="n">R</span><span class="o">-</span><span class="n">factor</span> <span class="o">=</span> <span class="mf">0.04380131351780189</span>
<span class="n">z1</span> <span class="o">=</span>  <span class="mf">5.25000</span>
<span class="n">z2</span> <span class="o">=</span>  <span class="mf">4.50000</span>
<span class="n">z3</span> <span class="o">=</span>  <span class="mf">3.50000</span>
<span class="p">[</span><span class="s1">&#39; 5.25000&#39;</span><span class="p">,</span> <span class="s1">&#39; 4.50000&#39;</span><span class="p">,</span> <span class="s1">&#39; 3.50000&#39;</span><span class="p">]</span>
<span class="o">...</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">z1</span></code>, <code class="docutils literal notranslate"><span class="pre">z2</span></code>, and <code class="docutils literal notranslate"><span class="pre">z3</span></code> are the candidate parameters at each step and the <code class="docutils literal notranslate"><span class="pre">R-factor</span></code> at that time.
The results of each step are also output to the folder <code class="docutils literal notranslate"><span class="pre">Logxxxxx</span></code> (where xxxxxx is the number of steps).
The final estimated parameters will be output to <code class="docutils literal notranslate"><span class="pre">res.dat</span></code>.
In the current case, the following result is obtained:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">z1</span> <span class="o">=</span> <span class="mf">5.230524973874179</span>
<span class="n">z2</span> <span class="o">=</span> <span class="mf">4.370622919269477</span>
<span class="n">z3</span> <span class="o">=</span> <span class="mf">3.5961444501081647</span>
</pre></div>
</div>
<p>You can see that we get the same value as the correct answer data <code class="docutils literal notranslate"><span class="pre">ref.txt</span></code>.
Note that <code class="docutils literal notranslate"><span class="pre">do.sh</span></code> is available as a script for batch calculation.
In <code class="docutils literal notranslate"><span class="pre">do.sh</span></code>, it also compares the difference between <code class="docutils literal notranslate"><span class="pre">res.txt</span></code> and <code class="docutils literal notranslate"><span class="pre">ref.txt</span></code>.
Here is what it does, without further explanation.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sh ./prepare.sh

./bulk.exe

time python3 ../../../../src/py2dmat_main.py input.toml | tee log.txt

echo diff res.txt ref.txt
res=0
diff res.txt ref.txt || res=$?
if [ $res -eq 0 ]; then
  echo Test PASS
  true
else
  echo Test FAILED: res.txt and ref.txt differ
  false
fi
</pre></div>
</div>
</section>
<section id="visualization-of-calculation-results">
<h2>Visualization of calculation results<a class="headerlink" href="#visualization-of-calculation-results" title="Link to this heading">¶</a></h2>
<p>The data of the rocking curve at each step is stored in <code class="docutils literal notranslate"><span class="pre">Logxxxx_00000001</span></code> (where <code class="docutils literal notranslate"><span class="pre">xxxx</span></code> is the index of steps) as <code class="docutils literal notranslate"><span class="pre">RockingCurve.txt</span></code>.
A tool <code class="docutils literal notranslate"><span class="pre">draw_RC_double.py</span></code> is provided to visualize this data.
In this section, we will use this tool to visualize the results.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="mi">0</span><span class="o">/</span><span class="n">Log00000001_00000001</span><span class="o">/</span><span class="n">RockingCurve</span><span class="o">.</span><span class="n">txt</span> <span class="n">RockingCurve_ini</span><span class="o">.</span><span class="n">txt</span>
<span class="n">cp</span> <span class="mi">0</span><span class="o">/</span><span class="n">Log00000062_00000001</span><span class="o">/</span><span class="n">RockingCurve</span><span class="o">.</span><span class="n">txt</span> <span class="n">RockingCurve_con</span><span class="o">.</span><span class="n">txt</span>
<span class="n">cp</span> <span class="o">../../../../</span><span class="n">script</span><span class="o">/</span><span class="n">draw_RC_double</span><span class="o">.</span><span class="n">py</span> <span class="o">.</span>
<span class="n">python</span> <span class="n">draw_RC_double</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Running the above will output <code class="docutils literal notranslate"><span class="pre">RC_double.png</span></code>.</p>
<figure class="align-default" id="id1">
<img alt="../_images/RC_double_minsearch.png" src="../_images/RC_double_minsearch.png" />
<figcaption>
<p><span class="caption-number">Fig. 2 </span><span class="caption-text">Analysis using the Nelder-Mead method. The red circle represents the experimental value, the blue line represents the first step, and the green line represents the rocking curve obtained at the last step.</span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>From the figure, we can see that the last step agrees with the experimental one.</p>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="sim_trhepd_rheed.html">TRHEPD Direct Problem Solver</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="mpi.html">Grid search</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2020, Institute for Solid State Physics, University of Tokyo.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    </div>
  </body>
</html>