<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Optimization by replica exchange Monte Carlo &#8212; 2DMAT 2.2.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/haiku.css?v=dfa0e015" />
    <script src="../_static/documentation_options.js?v=b21de401"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Replica Exchange Monte Carlo search with limitation" href="limitation.html" />
    <link rel="prev" title="Optimization by Bayesian Optimization" href="bayes.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../index.html">
          <span>2DMAT 2.2.0 documentation</span></a></h1>
        <h2 class="heading"><span>Optimization by replica exchange Monte Carlo</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="Top">
      
        <p>
        «&#160;&#160;<a href="bayes.html">Optimization by Bayesian Optimization</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="limitation.html">Replica Exchange Monte Carlo search with limitation</a>&#160;&#160;»
        </p>

      </div>
      <div class="content" role="main">
        
        
  <section id="optimization-by-replica-exchange-monte-carlo">
<h1>Optimization by replica exchange Monte Carlo<a class="headerlink" href="#optimization-by-replica-exchange-monte-carlo" title="Link to this heading">¶</a></h1>
<p>This tutorial subscribes how to estimate atomic positions from the experimental diffraction data by using the replica exchange Monte Carlo method (RXMC).</p>
<section id="sample-files">
<h2>Sample files<a class="headerlink" href="#sample-files" title="Link to this heading">¶</a></h2>
<p>Sample files are available from <code class="docutils literal notranslate"><span class="pre">sample/sim-trhepd-rheed/single_beam/exchange</span></code> .
This directory includes the following files:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">bulk.txt</span></code></p>
<p>The input file of <code class="docutils literal notranslate"><span class="pre">bulk.exe</span></code></p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">experiment.txt</span></code> , <code class="docutils literal notranslate"><span class="pre">template.txt</span></code></p>
<p>Reference files for the main program</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">ref.txt</span></code></p>
<p>Solution file for checking whether the calucation successes or not</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">input.toml</span></code></p>
<p>The input file of py2dmat</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">prepare.sh</span></code> , <code class="docutils literal notranslate"><span class="pre">do.sh</span></code></p>
<p>Script files for running this tutorial</p>
</li>
</ul>
<p>In the following, we will subscribe these files and then show the result.</p>
</section>
<section id="reference-files">
<h2>Reference files<a class="headerlink" href="#reference-files" title="Link to this heading">¶</a></h2>
<p>This tutorial uses reference files, <code class="docutils literal notranslate"><span class="pre">template.txt</span></code> and <code class="docutils literal notranslate"><span class="pre">experiment.txt</span></code>,
which are the same as the previous tutorial (<a class="reference internal" href="minsearch.html"><span class="doc">Optimization by Nelder-Mead method</span></a>) uses.</p>
</section>
<section id="input-files">
<h2>Input files<a class="headerlink" href="#input-files" title="Link to this heading">¶</a></h2>
<p>This subsection describes the input file.
For details, see <a class="reference internal" href="../algorithm/bayes.html#bayes-input"><span class="std std-ref">the manual of bayes</span></a>.
<code class="docutils literal notranslate"><span class="pre">input.toml</span></code> in the sample directory is shown as the following</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">base</span><span class="p">]</span>
<span class="n">dimension</span> <span class="o">=</span> <span class="mi">2</span>

<span class="p">[</span><span class="n">algorithm</span><span class="p">]</span>
<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;exchange&quot;</span>
<span class="n">label_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;z1&quot;</span><span class="p">,</span> <span class="s2">&quot;z2&quot;</span><span class="p">]</span>
<span class="n">seed</span> <span class="o">=</span> <span class="mi">12345</span>

<span class="p">[</span><span class="n">algorithm</span><span class="o">.</span><span class="n">param</span><span class="p">]</span>
<span class="n">min_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]</span>
<span class="n">max_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">]</span>

<span class="p">[</span><span class="n">algorithm</span><span class="o">.</span><span class="n">exchange</span><span class="p">]</span>
<span class="n">numsteps</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">numsteps_exchange</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">Tmin</span> <span class="o">=</span> <span class="mf">0.005</span>
<span class="n">Tmax</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">Tlogspace</span> <span class="o">=</span> <span class="n">true</span>

<span class="p">[</span><span class="n">solver</span><span class="p">]</span>
<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;sim-trhepd-rheed&quot;</span>

<span class="p">[</span><span class="n">solver</span><span class="o">.</span><span class="n">config</span><span class="p">]</span>
<span class="n">calculated_first_line</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">calculated_last_line</span> <span class="o">=</span> <span class="mi">74</span>
<span class="n">row_number</span> <span class="o">=</span> <span class="mi">2</span>

<span class="p">[</span><span class="n">solver</span><span class="o">.</span><span class="n">param</span><span class="p">]</span>
<span class="n">string_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;value_01&quot;</span><span class="p">,</span> <span class="s2">&quot;value_02&quot;</span> <span class="p">]</span>
<span class="n">degree_max</span> <span class="o">=</span> <span class="mf">7.0</span>

<span class="p">[</span><span class="n">solver</span><span class="o">.</span><span class="n">reference</span><span class="p">]</span>
<span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;experiment.txt&quot;</span>
<span class="n">first</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">last</span> <span class="o">=</span> <span class="mi">70</span>
</pre></div>
</div>
<p>In the following, we will briefly describe this input file.
For details, see the manual of <a class="reference internal" href="../algorithm/exchange.html"><span class="doc">Replica exchange Monte Carlo exchange</span></a>.</p>
<ul>
<li><p>The <code class="docutils literal notranslate"><span class="pre">[base]</span></code> section describes the settings for a whole calculation.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dimension</span></code> is the number of variables you want to optimize. In this case, specify <code class="docutils literal notranslate"><span class="pre">2</span></code> because it optimizes two variables.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">[solver]</span></code> section specifies the solver to use inside the main program and its settings.</p>
<blockquote>
<div><ul class="simple">
<li><p>See the minsearch tutorial.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">[algorithm]</span></code> section sets the algorithm to use and its settings.</p>
<blockquote>
<div><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">name</span></code> is the name of the algorithm you want to use, and in this tutorial we will use RXMC, so specify <code class="docutils literal notranslate"><span class="pre">exchange</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">label_list</span></code> is a list of label names to be given when outputting the value of <code class="docutils literal notranslate"><span class="pre">value_0x</span></code> (x = 1,2).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">seed</span></code> is the seed that a pseudo-random number generator uses.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">[algorithm.param]</span></code> section sets the parameter space to be explored.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">min_list</span></code> is a lower bound and <code class="docutils literal notranslate"><span class="pre">max_list</span></code> is an upper bound.</p></li>
</ul>
</div></blockquote>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">[algorithm.exchange]</span></code> section sets the parameters for RXMC.</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">numstep</span></code> is the number of Monte Carlo steps.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">numsteps_exchange</span></code> is the number of interval steps between temperature exchanges.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Tmin</span></code>, <code class="docutils literal notranslate"><span class="pre">Tmax</span></code> are the minimum and the maximum of temperature, respectively.</p></li>
<li><p>When <code class="docutils literal notranslate"><span class="pre">Tlogspace</span></code> is <code class="docutils literal notranslate"><span class="pre">true</span></code>, the temperature points are distributed uniformly in the logarithmic space.</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">[solver]</span></code> section specifies the solver to use inside the main program and its settings.</p>
<blockquote>
<div><ul class="simple">
<li><p>See the <a class="reference internal" href="minsearch.html"><span class="doc">Optimization by Nelder-Mead method</span></a> tutorial.</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</section>
<section id="calculation">
<h2>Calculation<a class="headerlink" href="#calculation" title="Link to this heading">¶</a></h2>
<p>First, move to the folder where the sample file is located (hereinafter, it is assumed that you are the root directory of 2DMAT).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">sample</span><span class="o">/</span><span class="n">sim</span><span class="o">-</span><span class="n">trhepd</span><span class="o">-</span><span class="n">rheed</span><span class="o">/</span><span class="n">single_beam</span><span class="o">/</span><span class="n">exchange</span>
</pre></div>
</div>
<p>Copy <code class="docutils literal notranslate"><span class="pre">bulk.exe</span></code> and <code class="docutils literal notranslate"><span class="pre">surf.exe</span></code> as the tutorial for the direct problem.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">../../../../../</span><span class="n">sim</span><span class="o">-</span><span class="n">trhepd</span><span class="o">-</span><span class="n">rheed</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">TRHEPD</span><span class="o">/</span><span class="n">bulk</span><span class="o">.</span><span class="n">exe</span> <span class="o">.</span>
<span class="n">cp</span> <span class="o">../../../../../</span><span class="n">sim</span><span class="o">-</span><span class="n">trhepd</span><span class="o">-</span><span class="n">rheed</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">TRHEPD</span><span class="o">/</span><span class="n">surf</span><span class="o">.</span><span class="n">exe</span> <span class="o">.</span>
</pre></div>
</div>
<p>Execute <code class="docutils literal notranslate"><span class="pre">bulk.exe</span></code> to generate <code class="docutils literal notranslate"><span class="pre">bulkP.b</span></code> .</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">bulk</span><span class="o">.</span><span class="n">exe</span>
</pre></div>
</div>
<p>Then, run the main program (it takes a few secondes)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mpiexec</span> <span class="o">-</span><span class="n">np</span> <span class="mi">4</span> <span class="n">python3</span> <span class="o">../../../../</span><span class="n">src</span><span class="o">/</span><span class="n">py2dmat_main</span><span class="o">.</span><span class="n">py</span> <span class="nb">input</span><span class="o">.</span><span class="n">toml</span> <span class="o">|</span> <span class="n">tee</span> <span class="n">log</span><span class="o">.</span><span class="n">txt</span>
</pre></div>
</div>
<p>Here, the calculation is performed using MPI parallel with 4 processes.
(If you are using Open MPI and you request more processes than you can use, add the <code class="docutils literal notranslate"><span class="pre">--oversubscribed</span></code> option to the <code class="docutils literal notranslate"><span class="pre">mpiexec</span></code> command.)</p>
<p>When executed, a folder for each rank will be created, and a <code class="docutils literal notranslate"><span class="pre">trial.txt</span></code> file containing the parameters evaluated in each Monte Carlo step and the value of the objective function, and a <code class="docutils literal notranslate"><span class="pre">result.txt</span></code> file containing the parameters actually adopted will be created.</p>
<p>These files have the same format: the first two columns are time (step) and the index of walker in the process, the third is the temperature, the fourth column is the value of the objective function, and the fifth and subsequent columns are the parameters.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># step walker T fx x1 x2</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mf">0.004999999999999999</span> <span class="mf">0.07830821484593968</span> <span class="mf">3.682008067401509</span> <span class="mf">3.9502750191292586</span>
<span class="mi">1</span> <span class="mi">0</span> <span class="mf">0.004999999999999999</span> <span class="mf">0.07830821484593968</span> <span class="mf">3.682008067401509</span> <span class="mf">3.9502750191292586</span>
<span class="mi">2</span> <span class="mi">0</span> <span class="mf">0.004999999999999999</span> <span class="mf">0.07830821484593968</span> <span class="mf">3.682008067401509</span> <span class="mf">3.9502750191292586</span>
<span class="mi">3</span> <span class="mi">0</span> <span class="mf">0.004999999999999999</span> <span class="mf">0.06273922648753057</span> <span class="mf">4.330900869594549</span> <span class="mf">4.311333132184154</span>
</pre></div>
</div>
<p>In the case of the sim-trhepd-rheed solver, a subfolder <code class="docutils literal notranslate"><span class="pre">Log%%%%%</span></code> (<code class="docutils literal notranslate"><span class="pre">%%%%%</span></code> is the number of MC steps) is created under each working folder, and locking curve information etc. are recorded.</p>
<p>Finally, <code class="docutils literal notranslate"><span class="pre">best_result.txt</span></code> is filled with information about the parameter with the optimal objective function (R-factor), the rank from which it was obtained, and the Monte Carlo step.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nprocs</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">rank</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">step</span> <span class="o">=</span> <span class="mi">65</span>
<span class="n">fx</span> <span class="o">=</span> <span class="mf">0.008233957976993406</span>
<span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">4.221129370933539</span>
<span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5.139591716517661</span>
</pre></div>
</div>
<p>In addition, <code class="docutils literal notranslate"><span class="pre">do.sh</span></code> is prepared as a script for batch calculation.
<code class="docutils literal notranslate"><span class="pre">do.sh</span></code> also checks the difference between <code class="docutils literal notranslate"><span class="pre">best_result.txt</span></code> and <code class="docutils literal notranslate"><span class="pre">ref.txt</span></code>.
I will omit the explanation below, but I will post the contents.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sh prepare.sh

./bulk.exe

time mpiexec --oversubscribe -np 4 python3 ../../../../src/py2dmat_main.py input.toml

echo diff best_result.txt ref.txt
res=0
diff best_result.txt ref.txt || res=$?
if [ $res -eq 0 ]; then
  echo TEST PASS
  true
else
  echo TEST FAILED: best_result.txt and ref.txt differ
  false
fi
</pre></div>
</div>
</section>
<section id="post-process">
<h2>Post process<a class="headerlink" href="#post-process" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">result.txt</span></code> in each rank folder records the data sampled by each replica, but the same replica holds samples at different temperatures because of the temperature exchanges.
2DMat provides a script, <code class="docutils literal notranslate"><span class="pre">script/separateT.py</span></code>, that rearranges the results of all replicas into samples by temperature.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="o">../../../../</span><span class="n">script</span><span class="o">/</span><span class="n">separateT</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>The data reorganized for each temperature point is written to <code class="docutils literal notranslate"><span class="pre">result_T%.txt</span></code> (<code class="docutils literal notranslate"><span class="pre">%</span></code> is the index of the temperature point).
The first column is the step, the second column is the rank, the third column is the value of the objective function, and the fourth and subsequent columns are the parameters.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># T = 0.004999999999999999</span>
<span class="c1"># step rank fx x1 x2</span>
<span class="mi">0</span> <span class="mi">0</span> <span class="mf">0.07830821484593968</span> <span class="mf">3.682008067401509</span> <span class="mf">3.9502750191292586</span>
<span class="mi">1</span> <span class="mi">0</span> <span class="mf">0.07830821484593968</span> <span class="mf">3.682008067401509</span> <span class="mf">3.9502750191292586</span>
<span class="mi">2</span> <span class="mi">0</span> <span class="mf">0.07830821484593968</span> <span class="mf">3.682008067401509</span> <span class="mf">3.9502750191292586</span>
</pre></div>
</div>
</section>
<section id="visualization">
<h2>Visualization<a class="headerlink" href="#visualization" title="Link to this heading">¶</a></h2>
<p>By illustrating <code class="docutils literal notranslate"><span class="pre">result_T.txt</span></code>, you can estimate regions where the parameters with small R-factor are.
In this case, the figure <code class="docutils literal notranslate"><span class="pre">result.png</span></code> of the 2D parameter space is created by using the following command.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span> <span class="n">plot_result_2d</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Looking at the resulting diagram, we can see that the samples are concentrated near (5.25, 4.25) and (4.25, 5.25), and that the <code class="docutils literal notranslate"><span class="pre">R-factor</span></code> value is small there.</p>
<figure class="align-default" id="id1">
<img alt="../_images/exchange.png" src="../_images/exchange.png" />
<figcaption>
<p><span class="caption-number">Fig. 4 </span><span class="caption-text">Sampled parameters and <code class="docutils literal notranslate"><span class="pre">R-factor</span></code>. The horizontal axes is <code class="docutils literal notranslate"><span class="pre">value_01</span></code>  and the vertical axes is <code class="docutils literal notranslate"><span class="pre">value_02</span></code> .</span><a class="headerlink" href="#id1" title="Link to this image">¶</a></p>
</figcaption>
</figure>
<p>Also, <code class="docutils literal notranslate"><span class="pre">RockingCurve.txt</span></code> is stored in each subfolder,
<code class="docutils literal notranslate"><span class="pre">LogXXX_YYY</span></code> (<code class="docutils literal notranslate"><span class="pre">XXX</span></code> is an index of MC step and <code class="docutils literal notranslate"><span class="pre">YYY</span></code> is an index of a replica in the MPI process).
By using this, it is possible to compare with the experimental value according to the procedure of the previous tutorial.</p>
</section>
</section>


      </div>
      <div class="bottomnav" role="navigation" aria-label="Bottom">
      
        <p>
        «&#160;&#160;<a href="bayes.html">Optimization by Bayesian Optimization</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="limitation.html">Replica Exchange Monte Carlo search with limitation</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2020, Institute for Solid State Physics, University of Tokyo.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.4.7.
    </div>
  </body>
</html>